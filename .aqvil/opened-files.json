{
  "files": [
    {
      "path": "backend/src/routes/players.ts",
      "content": "import express, { Request, Response, NextFunction } from 'express';\nimport { footballDataService } from '../services/footballDataApi';\nimport { influenceScoringService } from '../services/influenceScoring';\nimport { InfluenceScore, SearchResponse, PlayerComparison, LeaderboardEntry } from '../types';\n\nconst router = express.Router();\n\n/**\n * GET /api/players?name=NAME\n * Search for players by name\n */\nrouter.get('/', async (req: Request, res: Response, next: NextFunction) => {\n  try {\n    const { name } = req.query;\n\n    if (!name || typeof name !== 'string' || name.trim().length === 0) {\n      return res.status(400).json({\n        error: 'Player name is required',\n        code: 'INVALID_REQUEST',\n      });\n    }\n\n    const result = await footballDataService.searchPlayers(name.trim());\n    res.json(result);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/players/:id/stats\n * Get detailed player stats\n */\n    const { id } = req.params;\n\n    if (!id || isNaN(Number(id))) {\n      return res.status(400).json({\n        error: 'Player ID is required and must be a number',\n        code: 'INVALID_REQUEST',\n      });\n    }\n      });\n    }\n\n    if (!id) {\n      return res.status(400).json({\n        error: 'Player ID is required',\n        code: 'INVALID_REQUEST',\n      });\n    }\n\n    const playerData = await footballDataService.getPlayerStats(id);\n    res.json(playerData);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/players/:id/klout\n * Get influence score for a player\n */\nrouter.get('/:id/klout', async (req: Request, res: Response, next: NextFunction) => {\n  try {\n    const { id } = req.params;\n    const { position, league } = req.query;\n\n    if (!id) {\n      return res.status(400).json({\n        error: 'Player ID is required',\n        code: 'INVALID_REQUEST',\n      });\n    }\n\n    const { profile, stats } = await footballDataService.getPlayerStats(id);\n\n    // Get weights (use query params if provided)\n    let weights = undefined;\n    if (position && league) {\n      weights = influenceScoringService.getCombinedWeights(\n        position as string,\n        league as string\n      );\n    } else if (position) {\n      weights = influenceScoringService.getWeightsByPosition(position as string);\n    }\n\n    // Compute raw influence and normalize against top players\n    const topPlayers = await footballDataService.getTopPlayers(10);\n    const topInfluences = topPlayers.map((p) =>\n      influenceScoringService.computeRawInfluence(p.stats, weights)\n    );\n    const maxInfluence = Math.max(...topInfluences);\n\n    const influenceScore = influenceScoringService.computeInfluence(\n      id,\n      profile.name,\n      stats,\n      weights,\n      maxInfluence\n    );\n\n    res.json(influenceScore);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * GET /api/players/leaderboard?limit=10&league=Premier_League&position=Forward\n * Get top players by influence\n */\nrouter.get('/leaderboard/top', async (req: Request, res: Response, next: NextFunction) => {\n  try {\n    const { limit = 10, league, position } = req.query;\n    const limitNum = Math.min(parseInt(limit as string) || 10, 100);\n\n    const topPlayers = await footballDataService.getTopPlayers(limitNum);\n\n    // Compute influence scores\n    let influenceScores: InfluenceScore[] = topPlayers.map((p) => {\n      let weights = undefined;\n      if (position && league) {\n        weights = influenceScoringService.getCombinedWeights(\n          position as string,\n          league as string\n        );\n      } else if (position) {\n        weights = influenceScoringService.getWeightsByPosition(position as string);\n      }\n\n      return influenceScoringService.computeRawInfluence(p.stats, weights);\n    });\n\n    // Find max for normalization\n    const maxInfluence = Math.max(...influenceScores.map((raw) => raw));\n\n    // Convert raw scores to InfluenceScore objects\n    const leaderboard: LeaderboardEntry[] = topPlayers.map((p, idx) => {\n      let weights = undefined;\n      if (position && league) {\n        weights = influenceScoringService.getCombinedWeights(\n          position as string,\n          league as string\n        );\n      } else if (position) {\n        weights = influenceScoringService.getWeightsByPosition(position as string);\n      }\n\n      return {\n        rank: idx + 1,\n        player: {\n          id: p.id,\n          name: p.name,\n          club: p.club,\n          position: p.position,\n          nationality: p.nationality,\n          age: p.age,\n          photo: p.photo,\n          shirtNumber: p.shirtNumber,\n        },\n        influence: influenceScoringService.computeInfluence(\n          p.id,\n          p.name,\n          p.stats,\n          weights,\n          maxInfluence\n        ),\n      };\n    });\n\n    res.json(leaderboard);\n  } catch (error) {\n    next(error);\n  }\n});\n\n/**\n * POST /api/players/compare\n * Compare multiple players side-by-side\n */\nrouter.post('/compare', async (req: Request, res: Response, next: NextFunction) => {\n  try {\n    const { playerIds } = req.body;\n\n    if (!Array.isArray(playerIds) || playerIds.length < 2 || playerIds.length > 5) {\n      return res.status(400).json({\n        error: 'Please provide 2-5 player IDs for comparison',\n        code: 'INVALID_REQUEST',\n      });\n    }\n\n    // Fetch all players\n    const playerPromises = playerIds.map((id: string) =>\n      footballDataService.getPlayerStats(id)\n    );\n    const playersData = await Promise.all(playerPromises);\n\n    // Compute influence scores\n    const influenceScores = playersData.map((p) =>\n      influenceScoringService.computeInfluence(\n        p.profile.id,\n        p.profile.name,\n        p.stats\n      )\n    );\n\n    // Find max for normalization\n    const allRawInfluences = influenceScores.map((s) => s.influence);\n    const maxInfluence = Math.max(...allRawInfluences);\n\n    // Recompute with proper normalization\n    const normalizedScores = playersData.map((p) =>\n      influenceScoringService.computeInfluence(\n        p.profile.id,\n        p.profile.name,\n        p.stats,\n        undefined,\n        maxInfluence\n      )\n    );\n\n    const comparison: PlayerComparison = {\n      players: playersData.map((p, idx) => ({\n        ...p,\n        influenceScore: normalizedScores[idx],\n      })),\n      maxInfluence: maxInfluence,\n    };\n\n    res.json(comparison);\n  } catch (error) {\n    next(error);\n  }\n});\n\nexport default router;\n",
      "previousContent": null,
      "language": "auto"
    }
  ]
}